---
layout: default
title: hirrdirr â€¢ Dodge & Drift
navlabel: games
---

<link rel="stylesheet" href="/games/dnd/dnd.css" />

<div class="dnd-page">
  <canvas id="c"></canvas>

  <div class="hud">
    <div class="panel">
      <div>Score: <span id="score">0</span></div>
      <div class="small">PB: <span id="high">0</span></div>
    </div>
    <div class="panel small" id="status">Ready</div>
  </div>

  <div class="center" id="overlay">
    <div class="card">
      <h2 class="title">Dodge &amp; Drift</h2>
      <div class="small help">
        Styr med <span class="kbd">WASD</span> / <span class="kbd">Pilar</span>.
        Pausa med <span class="kbd">P</span>. Mobil: dra fingret.
        Ã–verlev sÃ¥ lÃ¤nge du kan. Hinder blir snabbareâ€¦ fÃ¶r att universum Ã¤r elakt.
      </div>
      <button id="start">Starta</button>

      <div class="hs-wrap">
        <div class="hs-title">Topplista</div>
        <ol class="hs" id="hsList"></ol>
      </div>

      <div id="latestWrap" class="small" style="margin-top:10px; opacity:.9;">
        Latest attempt â€“ <span id="latestScore">â€”</span> score
      </div>

      <div id="nameEntry" style="display:none; margin-top:12px;">
        <div class="small" style="margin: 6px 0 6px; opacity:.9;">
          Ny highscore! Skriv ditt namn:
        </div>
        <form id="nameForm" autocomplete="off">
          <input id="playerName" type="text" maxlength="12" placeholder="Ditt namn"
            style="width:100%; padding:10px; border-radius:10px; border:1px solid rgba(255,255,255,.15); background:rgba(0,0,0,.25); color:inherit;" />
          <button type="submit" style="margin-top:8px; width:100%;">Spara</button>
        </form>
        <div id="nameHint" class="small" style="margin-top:6px; opacity:.8; display:none;"></div>
      </div>
    </div>
  </div>
</div>

<!-- Scripts MUST be placed after the canvas/DOM exists -->
<script src="/games/dnd/supabase-config.js"></script>
<script src="/games/dnd/dnd.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>

<script>
(() => {
  // === Supabase config ===
  const SUPABASE_URL = window.SUPABASE_URL;
  const SUPABASE_ANON_KEY = window.SUPABASE_ANON_KEY;

  // Your table or view name:
  // - If you created the view: "top10_scores" (recommended)
  // - Otherwise: "scores"
  const TOP_SOURCE = "top10_scores";
  const TABLE_INSERT = "scores";

  const HS_MAX = 10;

  // Local caches (UX): avoids empty leaderboard/high=0 flashes on refresh.
  const LS_LATEST = "dnd.latestAttempt.v1";
  const LS_PLAYER = "dnd.playerName.v1";
  const LS_TOPCACHE = "dnd.top10.cache.v1";
  const LS_PB = "dnd.personalBest.v1";

  const hsListEl = document.getElementById("hsList");
  const highEl = document.getElementById("high");
  const latestScoreEl = document.getElementById("latestScore");

  const nameEntryEl = document.getElementById("nameEntry");
  const nameFormEl = document.getElementById("nameForm");
  const playerNameEl = document.getElementById("playerName");
  const nameHintEl = document.getElementById("nameHint");

  let client = null;
  let cachedTop = [];
  let pendingScore = null;

  function hasConfig() {
    return SUPABASE_URL && SUPABASE_ANON_KEY &&
      !String(SUPABASE_URL).includes("PASTE_YOUR_SUPABASE") &&
      !String(SUPABASE_ANON_KEY).includes("PASTE_YOUR_SUPABASE");
  }

  function parseIntSafe(s) {
    const n = parseInt(String(s).replace(/[^0-9-]/g, ""), 10);
    return Number.isFinite(n) ? n : 0;
  }

  function setLatest(score) {
    localStorage.setItem(LS_LATEST, String(score));
    if (latestScoreEl) latestScoreEl.textContent = String(score);
  }

  function renderLatestFromStorage() {
    const v = localStorage.getItem(LS_LATEST);
    if (latestScoreEl) latestScoreEl.textContent = v ? v : "â€”";
  }

  function getPB() {
    const v = localStorage.getItem(LS_PB);
    const n = parseIntSafe(v ?? 0);
    return Math.max(0, n);
  }

  function setPB(score) {
    const s = Math.max(0, parseIntSafe(score));
    const pb = getPB();
    const next = Math.max(pb, s);
    localStorage.setItem(LS_PB, String(next));
    if (highEl) highEl.textContent = String(next);
  }

  function renderPBFromStorage() {
    if (highEl) highEl.textContent = String(getPB());
  }

  function loadTopCache() {
    try {
      const raw = localStorage.getItem(LS_TOPCACHE);
      if (!raw) return [];
      const arr = JSON.parse(raw);
      if (!Array.isArray(arr)) return [];
      return arr
        .map(r => ({ name: String(r?.name ?? "Anon").slice(0, 12), score: Number(r?.score ?? 0) || 0 }))
        .filter(r => r.score >= 0)
        .slice(0, HS_MAX);
    } catch {
      return [];
    }
  }

  function saveTopCache(list) {
    try {
      localStorage.setItem(LS_TOPCACHE, JSON.stringify(list.slice(0, HS_MAX)));
    } catch {}
  }

  function renderTop(list, { loading = false } = {}) {
    if (!hsListEl) return;

    if (!list.length && loading) {
      hsListEl.innerHTML = '<li style="opacity:.75;">Laddar topplistanâ€¦</li>';
      return;
    }

    // Keep existing list if we have no new data (e.g. fetch failed).
    if (!list.length && hsListEl.children.length) return;

    hsListEl.innerHTML = "";
    list.slice(0, HS_MAX).forEach((row, i) => {
      const li = document.createElement("li");
      li.style.display = "flex";
      li.style.justifyContent = "space-between";
      li.style.gap = "12px";

      const left = document.createElement("span");
      left.textContent = `${i + 1}. ${row.name}`;

      const right = document.createElement("span");
      right.textContent = `${row.score} score`;

      li.appendChild(left);
      li.appendChild(right);
      hsListEl.appendChild(li);
    });
  }

  function qualifies(score, list) {
    if (score <= 0) return false;
    if (list.length < HS_MAX) return true;
    const last = list[list.length - 1]?.score ?? 0;
    return score > last;
  }

  function showNameEntry(score) {
    pendingScore = score;
    if (!nameEntryEl) return;

    if (nameHintEl) {
      nameHintEl.style.display = "none";
      nameHintEl.textContent = "";
    }

    nameEntryEl.style.display = "block";

    const savedName = localStorage.getItem(LS_PLAYER) || "";
    if (playerNameEl) {
      playerNameEl.value = savedName;
      setTimeout(() => playerNameEl.focus(), 0);
      setTimeout(() => playerNameEl.select(), 0);
    }
  }

  function hideNameEntry() {
    pendingScore = null;
    if (nameEntryEl) nameEntryEl.style.display = "none";
  }

  function normalizeName(name) {
    const n = String(name ?? "").trim().slice(0, 12);
    return n.length ? n : "Anon";
  }

  async function fetchTop10() {
    if (!client) return null;

    try {
      if (TOP_SOURCE === "top10_scores") {
        const { data, error } = await client.from("top10_scores").select("name,score,created_at");
        if (error) throw error;
        return (data || []).map(r => ({ name: String(r.name), score: Number(r.score) || 0 }));
      } else {
        const { data, error } = await client
          .from("scores")
          .select("name,score,created_at")
          .order("score", { ascending: false })
          .order("created_at", { ascending: true })
          .limit(HS_MAX);
        if (error) throw error;
        return (data || []).map(r => ({ name: String(r.name), score: Number(r.score) || 0 }));
      }
    } catch (e) {
      console.warn("[Supabase] fetchTop10 failed:", e);
      return null; // null = keep cache
    }
  }

  async function refreshTop({ showLoading = false } = {}) {
    if (showLoading) renderTop(cachedTop, { loading: true });

    const fresh = await fetchTop10();

    if (fresh && fresh.length) {
      cachedTop = fresh;
      saveTopCache(cachedTop);
      renderTop(cachedTop);
      return;
    }

    if (Array.isArray(fresh) && fresh.length === 0) {
      // Supabase says: leaderboard is empty. Clear cache so ALL users see the reset on next refresh.
      cachedTop = [];
      saveTopCache([]);
      if (hsListEl) hsListEl.innerHTML = '<li style="opacity:.75;">Ingen score Ã¤nnu. Bli den fÃ¶rsta. ðŸ˜ˆ</li>';
            return;
    }

    // null => fetch failed; keep cached render as-is (avoid flicker on transient network issues)
  }

  async function submitScore(name, score) {
    if (!client) return false;

    const safeName = normalizeName(name);
    const safeScore = Math.max(0, parseIntSafe(score));

    try {
      const { error } = await client.from(TABLE_INSERT).insert([{ name: safeName, score: safeScore }]);
      if (error) throw error;

      localStorage.setItem(LS_PLAYER, safeName);
      return true;
    } catch (e) {
      console.warn("[Supabase] submitScore failed:", e);
      if (nameHintEl) {
        nameHintEl.textContent = "Kunde inte spara. Dubbelkolla RLS policies + att name/score Ã¤r inom grÃ¤nserna.";
        nameHintEl.style.display = "block";
      }
      return false;
    }
  }

  // --- Game-over integration ---
  // dnd_clean.js dispatches: window.dispatchEvent(new CustomEvent('dnd:gameover', { detail: { score, ts } }))
  async function onGameOver(detail) {
    const finalScore = Math.max(0, parseIntSafe(detail?.score ?? 0));
    setLatest(finalScore);
    setPB(finalScore);

    // Get fresh top10 before deciding qualification.
    await refreshTop();

    if (qualifies(finalScore, cachedTop)) showNameEntry(finalScore);
    else hideNameEntry();
  }

  window.addEventListener("dnd:gameover", (e) => onGameOver(e.detail));

  // --- Submit form ---
  if (nameFormEl) {
    nameFormEl.addEventListener("submit", async (e) => {
      e.preventDefault();
      if (pendingScore == null) return;

      // Basic UX: disable button while saving
      const btn = nameFormEl.querySelector("button[type='submit']");
      if (btn) { btn.disabled = true; btn.textContent = "Spararâ€¦"; }

      const ok = await submitScore(playerNameEl?.value, pendingScore);

      if (btn) { btn.disabled = false; btn.textContent = "Spara"; }

      if (ok) {
        hideNameEntry();
        await refreshTop({ showLoading: true });
        // Periodic refresh so resets propagate automatically
        setInterval(() => refreshTop(), 20000);
        window.addEventListener('focus', () => refreshTop());
      }
    });
  }

  // --- Init ---
  renderLatestFromStorage();
  renderPBFromStorage();

  // Load cached Top 10 immediately to avoid refresh blink
  cachedTop = loadTopCache();
  if (cachedTop.length) renderTop(cachedTop);
  else renderTop([], { loading: true });

  if (hasConfig()) {
    // Wait until supabase UMD is actually available
    const initClient = () => {
      if (window.supabase?.createClient) {
        client = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        refreshTop({ showLoading: true });
        // Periodic refresh so resets propagate automatically
        setInterval(() => refreshTop(), 20000);
        window.addEventListener('focus', () => refreshTop());
      } else {
        setTimeout(initClient, 50);
      }
    };
    initClient();
  } else {
    console.warn("[Supabase] Missing config. Ensure /games/dnd/supabase-config.js sets window.SUPABASE_URL and window.SUPABASE_ANON_KEY.");
    if (hsListEl) hsListEl.innerHTML = '<li style="opacity:.75;">Leaderboard offline (saknar Supabase-config).</li>';
  }
})();
</script>
